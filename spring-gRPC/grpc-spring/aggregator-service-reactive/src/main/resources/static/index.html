<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
          background-color: #f8f9fa;
        }
        .card {
          border-radius: 12px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        #stock-list .card {
          height: 100%;
        }
        #stock-list .card .card-header {
          font-weight: bold;
          font-size: 1.1rem;
        }
        #stock-list .btn {
          font-size: 0.9rem;
          padding: 0.4rem;
        }
    </style>
</head>
<body>
<div class="container my-4">
    <!-- Header -->
    <h2 class="text-center mb-4">Trading Platform</h2>

    <!-- Top Row: Stock List -->
    <div class="row g-3 mb-4" id="stock-list"></div>

    <!-- Bottom Row: Profile & Portfolio -->
    <div class="row g-3">
        <!-- Profile -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">Profile</div>
                <div class="card-body">
                    <h5 id="trader-profile-name">guest</h5>
                    <p><strong>Available Balance:</strong> <span id="trader-available-balance">$10000.00</span></p>
                    <p><strong>Portfolio Value:</strong> <span id="trader-portfolio-value">$0.00</span></p>
                </div>
            </div>
        </div>

        <!-- Portfolio -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">Portfolio</div>
                <div class="card-body p-0">
                    <table class="table mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Stock</th>
                            <th>Quantity</th>
                            <th>Purchase Price</th>
                            <th>Current Value</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="portfolio-body">
                        <!-- Holdings rows go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    <div id="alerts" class="mt-3"></div>
</div>

<!-- Sell Modal -->
<div class="modal fade" id="sellModal" tabindex="-1" aria-labelledby="sellModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="sellForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="sellModalLabel">Sell Holding</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="sellHoldingId">
                    <input type="hidden" id="sellStock">
                    <div class="mb-3">
                        <label for="sellQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="sellQuantity" min="1" required>
                        <div class="form-text" id="sellMaxText"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Sell</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // STOCKS
    const stockSymbols = ["APPLE", "AMAZON", "GOOGLE", "MICROSOFT"];
    let stockPrices = {};
    let holdings = [];
    let balance = 10000;
    const traderId = new URLSearchParams(window.location.search).get("trader") || "guest";

    // Elements
    const traderProfileNameElement = document.getElementById("trader-profile-name");
    const traderPortfolioValueElement = document.getElementById("trader-portfolio-value");
    const traderAvailableBalanceElement = document.getElementById("trader-available-balance");
    const traderPortfolioContainer = document.getElementById("portfolio-body");
    const stockList = document.getElementById("stock-list");
    const alerts = document.getElementById("alerts");

    traderProfileNameElement.textContent = traderId;

    // RENDER STOCK CARDS
    function renderStockCards() {
      stockList.innerHTML = "";
      stockSymbols.forEach(symbol => {
        stockList.innerHTML += `
          <div class="col-sm-6 col-md-3">
            <div class="card">
              <div class="card-header text-center"><strong>${symbol}</strong></div>
              <div class="card-body text-center">
                <h5 class="mb-3" id="${symbol}">$0.00</h5>
                <div class="d-grid gap-2">
                  <button class="btn btn-success" onclick="trade('${symbol}','BUY')">Buy</button>
                </div>
              </div>
            </div>
          </div>`;
      });
    }

    // RENDER PORTFOLIO
    function renderPortfolio() {
      traderPortfolioContainer.innerHTML = "";
      let totalValue = 0;
      holdings.forEach((h, i) => {
        const currentPrice = stockPrices[h.stock] || h.purchasePrice;
        const value = h.quantity * currentPrice;
        totalValue += value;
        traderPortfolioContainer.innerHTML += `
          <tr>
            <th scope="row">${i + 1}</th>
            <td>${h.stock}</td>
            <td>${h.quantity}</td>
            <td>$${h.purchasePrice.toFixed(2)}</td>
            <td>$${value.toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-danger"
                      onclick="openSellModal('${h.holdingId}','${h.stock}',${h.quantity})">
                Sell
              </button>
            </td>
          </tr>`;
      });
      traderPortfolioValueElement.textContent = `$${totalValue.toFixed(2)}`;
      traderAvailableBalanceElement.textContent = `$${balance.toFixed(2)}`;
    }

    // TRADE (BUY request -> backend)
    async function trade(symbol, type) {
      if (type === "BUY") {
        const shares = parseInt(prompt(`Enter number of shares to buy for ${symbol}:`), 10);
        if (shares > 0) {
          const price = stockPrices[symbol] || 100;
          const cost = shares * price;
          if (balance < cost) {
            showAlert("Not enough balance!", "danger");
            return;
          }
          const request = {
            trader_id: 1,
            stock: symbol,
            trade_price: price,
            quantity: shares,
            action: "BUY"
          };
          const res = await fetch("/v2/trade", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(request)
          });
          const result = await res.json();
          balance = result.balance;
          holdings = result.updatedHoldings;
          renderPortfolio();
          showAlert(`Bought ${shares} shares of ${symbol}`, "success");
        }
      }
    }

    // Open Sell Modal
    function openSellModal(holdingId, stock, maxQuantity) {
      document.getElementById("sellHoldingId").value = holdingId;
      document.getElementById("sellStock").value = stock;
      document.getElementById("sellQuantity").value = maxQuantity;
      document.getElementById("sellQuantity").max = maxQuantity;
      document.getElementById("sellMaxText").innerText = `Max available: ${maxQuantity}`;
      new bootstrap.Modal(document.getElementById("sellModal")).show();
    }

    // Handle Sell Form
    document.getElementById("sellForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const holdingId = document.getElementById("sellHoldingId").value;
      const stock = document.getElementById("sellStock").value;
      const quantity = parseInt(document.getElementById("sellQuantity").value);
      const request = {
        trader_id: 1,
        stock: stock,
        quantity: quantity,
        action: "SELL",
        holding_id: holdingId
      };
      const res = await fetch("/v2/trade", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(request)
      });
      const result = await res.json();
      balance = result.balance;
      holdings = result.updatedHoldings;
      renderPortfolio();
      bootstrap.Modal.getInstance(document.getElementById("sellModal")).hide();
      showAlert(`Sold ${quantity} shares of ${stock}`, "success");
    });

    // ALERTS
    function showAlert(message, type) {
      alerts.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    // SSE for live prices
    function subscribeStockUpdates() {
      const source = new EventSource("/v2/stock/updates");
      source.onmessage = (evt) => {
        const update = JSON.parse(evt.data);
        stockPrices[update.stock] = update.price;
        const priceElement = document.getElementById(update.stock);
        if (priceElement) {
          priceElement.textContent = `$${update.price.toFixed(2)}`;
        }
        renderPortfolio();
      };
      source.onerror = () => showAlert("Lost connection to stock updates", "warning");
    }

    // INIT
    renderStockCards();
    renderPortfolio();
    subscribeStockUpdates();
</script>
</body>
</html>
